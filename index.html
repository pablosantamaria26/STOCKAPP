<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock App - Mercado Limpio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style> body, html { height: 100%; overflow: hidden; } </style>
</head>
<body x-data="app()" x-init="cargarCatalogos()" class="bg-gray-100 flex flex-col h-screen">

    <header class="bg-blue-900 text-white p-3 flex justify-between items-center shadow-lg z-10 gap-4">
        <div class="flex items-center gap-2 overflow-hidden">
            <h1 class="font-bold text-lg whitespace-nowrap hidden md:block">ðŸ“¦ Stock</h1>
            
            <select x-model="catalogoActual" @change="cambiarCatalogo()" class="text-black text-sm rounded px-2 py-1 max-w-[200px] md:max-w-xs">
                <option value="">ðŸ“‚ Seleccionar Proveedor...</option>
                <template x-for="cat in listaCatalogos" :key="cat.id">
                    <option :value="cat.url" x-text="cat.nombre"></option>
                </template>
            </select>
            
            <span x-show="cargando" class="text-xs animate-pulse text-yellow-300">Buscando PDFs...</span>
        </div>
        
        <button @click="copiarResumen()" class="bg-green-500 hover:bg-green-600 px-3 py-1 rounded text-sm font-bold shadow whitespace-nowrap">
            ðŸ“‹ Enviar Pedido
        </button>
    </header>

    <div class="flex flex-1 overflow-hidden">
        
        <div class="w-full md:w-2/3 h-full bg-gray-800 relative border-r border-gray-600">
            <template x-if="catalogoActual">
                <iframe :src="catalogoActual" class="w-full h-full" allow="autoplay"></iframe>
            </template>
            
            <template x-if="!catalogoActual">
                <div class="flex flex-col items-center justify-center h-full text-white opacity-50 text-center p-4">
                    <p class="text-4xl mb-2">ðŸ“„</p>
                    <p>Selecciona un proveedor arriba<br>para ver su catÃ¡logo.</p>
                </div>
            </template>
        </div>

        <div class="w-full md:w-1/3 bg-white flex flex-col shadow-xl z-20 border-l border-gray-300">
            <div class="p-3 bg-gray-50 border-b border-gray-200">
                <div class="flex gap-2 mb-2">
                    <input type="text" x-model="nuevoItem.nombre" @keydown.enter="$refs.qty.focus()" placeholder="Producto..." class="w-2/3 p-2 border rounded focus:ring-2 focus:ring-blue-500 text-sm">
                    <input type="number" x-ref="qty" x-model="nuevoItem.cantidad" @keydown.enter="agregar()" placeholder="#" class="w-1/3 p-2 border rounded focus:ring-2 focus:ring-blue-500 text-sm">
                </div>
                <button @click="agregar()" class="w-full bg-blue-800 text-white py-2 rounded text-sm font-bold hover:bg-blue-700">AGREGAR</button>
            </div>

            <div class="flex-1 overflow-y-auto p-2 space-y-2 bg-white">
                <template x-for="(item, index) in items" :key="index">
                    <div class="flex justify-between items-center bg-blue-50 p-2 rounded border border-blue-100 shadow-sm">
                        <span class="font-medium text-gray-700 text-sm" x-text="item.nombre"></span>
                        <div class="flex items-center gap-3">
                            <span class="font-bold text-blue-900" x-text="item.cantidad"></span>
                            <button @click="eliminar(index)" class="text-red-400 hover:text-red-600 font-bold px-2">Ã—</button>
                        </div>
                    </div>
                </template>
            </div>
            
            <div class="p-2 bg-gray-100 text-right text-xs text-gray-500 border-t">
                <span x-text="items.length"></span> productos en lista
            </div>
        </div>
    </div>

    <script>
        function app() {
            return {
                // âš ï¸ PEGA AQUÃ TU URL DE APPS SCRIPT (la que termina en /exec)
                apiUrl: 'https://script.google.com/macros/s/AKfycbySwsXfzeNUHi3VWqGWcJtMmpzLjkSRlBEs7a8_FoaGKqgifoBJRFqAhIV_oTTHAJf40A/exec', 
                
                listaCatalogos: [],
                catalogoActual: '',
                cargando: false,
                nuevoItem: { nombre: '', cantidad: '' },
                items: JSON.parse(localStorage.getItem('stock_pedido')) || [],

                async cargarCatalogos() {
                    if(this.apiUrl === 'TU_URL_DEL_SCRIPT_AQUI') return; // PrevenciÃ³n si no has pegado la url
                    
                    this.cargando = true;
                    try {
                        const response = await fetch(this.apiUrl);
                        const data = await response.json();
                        // Ordenar alfabÃ©ticamente
                        this.listaCatalogos = data.sort((a,b) => a.nombre.localeCompare(b.nombre));
                    } catch (e) {
                        alert("Error cargando catÃ¡logos: " + e);
                    }
                    this.cargando = false;
                },

                cambiarCatalogo() {
                    // Limpiar lista si se cambia de proveedor (opcional)
                    // if(confirm('Â¿Limpiar lista actual?')) this.items = [];
                },

                agregar() {
                    if (!this.nuevoItem.nombre || !this.nuevoItem.cantidad) return;
                    this.items.unshift({ ...this.nuevoItem });
                    localStorage.setItem('stock_pedido', JSON.stringify(this.items));
                    this.nuevoItem = { nombre: '', cantidad: '' };
                },

                eliminar(index) {
                    this.items.splice(index, 1);
                    localStorage.setItem('stock_pedido', JSON.stringify(this.items));
                },

                copiarResumen() {
                    let texto = "*PEDIDO STOCK*\n\n";
                    this.items.forEach(i => texto += `â€¢ ${i.cantidad} x ${i.nombre}\n`);
                    const link = `https://wa.me/?text=${encodeURIComponent(texto)}`;
                    window.open(link, '_blank'); // Abre WhatsApp Web directo
                }
            }
        }
    </script>
</body>
</html>
