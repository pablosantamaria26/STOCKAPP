<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Stock S9</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>

    <style>
        /* Optimizaci√≥n Dark Mode S9 (Negros Puros) */
        body { background-color: #000000; color: #e0e0e0; overflow: hidden; font-family: sans-serif; }
        
        /* Capa de texto invisible para la IA */
        .textLayer { position: absolute; left: 0; top: 0; right: 0; bottom: 0; overflow: hidden; opacity: 0.1; line-height: 1.0; pointer-events: none; }
        .textLayer span { color: transparent; position: absolute; white-space: pre; cursor: pointer; pointer-events: auto; }
        
        /* Efecto al tocar un producto */
        .textLayer span:active { background-color: rgba(0, 255, 0, 0.4) !important; border-radius: 4px; }
        
        /* Loader animado */
        .loader { border: 4px solid rgba(255,255,255,0.1); border-left-color: #3b82f6; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>

<body x-data="app()" x-init="init()" class="h-screen flex flex-col relative">

    <div class="absolute top-0 left-0 right-0 z-30 p-2 pointer-events-none">
        <div class="pointer-events-auto bg-gray-900/95 backdrop-blur border border-gray-700 rounded-xl shadow-2xl p-2 flex gap-2 items-center justify-between">
            
            <div class="relative flex-1">
                <select x-model="catalogoId" @change="cargarCatalogoSeleccionado()" 
                        class="w-full bg-gray-800 text-white text-sm rounded-lg py-2 pl-3 pr-8 appearance-none focus:ring-2 focus:ring-blue-500 outline-none border border-gray-600">
                    <option value="">üìÇ Seleccionar Proveedor...</option>
                    <template x-for="c in listaCatalogos" :key="c.id">
                        <option :value="c.id" x-text="c.nombre"></option>
                    </template>
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-400">‚ñº</div>
            </div>

            <button @click="verResumen()" class="bg-green-600 px-3 py-2 rounded-lg font-bold text-white shadow active:scale-95 flex items-center gap-1">
                <span>üõí</span> <span x-text="items.length"></span>
            </button>
        </div>
        
        <div x-show="cargando" class="mt-2 mx-2 bg-gray-800 rounded-full h-1 overflow-hidden pointer-events-auto">
            <div class="bg-blue-500 h-full animate-pulse w-full"></div>
        </div>
        <div x-show="cargando" class="text-center text-xs text-blue-400 font-bold mt-1 shadow-black drop-shadow-md">
            üöÄ Descargando Cat√°logo al dispositivo...
        </div>
    </div>

    <div id="pdf-container" class="flex-1 overflow-auto bg-black relative touch-pan-x touch-pan-y flex justify-center pt-16 pb-24">
        <div class="relative shadow-2xl border border-gray-800 bg-gray-900 min-h-[500px]" :class="{'opacity-50': cargando}">
            <canvas id="the-canvas" class="block"></canvas>
            <div id="text-layer" class="textLayer"></div>
            
            <div x-show="!pdfDoc && !cargando" class="absolute inset-0 flex flex-col items-center justify-center text-gray-500 gap-4">
                <div class="text-6xl">üì°</div>
                <p>Conectando con Drive...</p>
            </div>
        </div>
    </div>

    <div x-show="pdfDoc" class="fixed bottom-24 right-4 z-20 flex flex-col gap-3 pointer-events-auto">
        <button @click="cambiarPag(-1)" class="w-12 h-12 bg-gray-800/90 rounded-full text-white border border-gray-600 shadow-xl text-xl flex items-center justify-center backdrop-blur active:scale-90">‚¨Ü</button>
        <button @click="cambiarPag(1)" class="w-12 h-12 bg-gray-800/90 rounded-full text-white border border-gray-600 shadow-xl text-xl flex items-center justify-center backdrop-blur active:scale-90">‚¨á</button>
    </div>

    <div class="fixed inset-x-0 bottom-0 z-50 transform transition-transform duration-300 bg-gray-900 border-t border-gray-700 rounded-t-3xl shadow-[0_-10px_60px_rgba(0,0,0,1)] pb-2"
         :class="modalOpen ? 'translate-y-0' : 'translate-y-full'">
        
        <div class="bg-gray-800 rounded-t-3xl p-3 flex justify-between items-center border-b border-gray-700" @click="modalOpen = false">
            <span class="text-xs font-bold text-gray-400 uppercase tracking-wider">Producto Detectado</span>
            <div class="w-10 h-1 bg-gray-600 rounded-full"></div>
            <button class="text-gray-400 text-xl px-2">‚úï</button>
        </div>

        <div class="p-4 space-y-4">
            <input type="text" x-model="form.nombre" class="w-full bg-transparent text-lg font-bold text-white border-b border-gray-600 focus:border-blue-500 outline-none py-1 placeholder-gray-600" placeholder="Nombre del producto...">

            <div class="grid grid-cols-2 gap-3">
                <button @click="form.tipo = 'unidades'" :class="form.tipo === 'unidades' ? 'bg-blue-700 text-white shadow-lg shadow-blue-900/50' : 'bg-gray-800 text-gray-400'" class="py-3 rounded-xl font-bold text-sm transition-all border border-gray-700">
                    üì¶ UNIDAD
                </button>
                <button @click="form.tipo = 'bulto'" :class="form.tipo === 'bulto' ? 'bg-purple-700 text-white shadow-lg shadow-purple-900/50' : 'bg-gray-800 text-gray-400'" class="py-3 rounded-xl font-bold text-sm transition-all border border-gray-700">
                    üß± BULTO
                </button>
            </div>

            <div class="flex gap-3">
                <div class="flex items-center bg-gray-800 rounded-xl border border-gray-700 w-1/3">
                    <button @click="form.cantidad > 1 ? form.cantidad-- : null" class="w-8 h-full text-gray-400 text-xl">-</button>
                    <input type="number" x-model="form.cantidad" class="w-full bg-transparent text-center font-bold text-white text-xl outline-none py-3">
                    <button @click="form.cantidad++" class="w-8 h-full text-gray-400 text-xl">+</button>
                </div>
                
                <button @click="guardar()" class="flex-1 bg-gradient-to-r from-green-600 to-green-700 text-white font-bold rounded-xl shadow-lg active:scale-95 transition-transform flex justify-center items-center gap-2">
                    CONFIRMAR
                </button>
            </div>
        </div>
    </div>

    <script>
        function app() {
            return {
                // ‚ö†Ô∏è PEGA AQU√ç TU NUEVA URL DEL SCRIPT (v2.0)
                apiUrl: 'https://script.google.com/macros/s/AKfycbySwsXfzeNUHi3VWqGWcJtMmpzLjkSRlBEs7a8_FoaGKqgifoBJRFqAhIV_oTTHAJf40A/exec',
                
                listaCatalogos: [],
                catalogoId: '',
                items: JSON.parse(localStorage.getItem('stock_drive')) || [],
                
                // PDF Engine
                pdfDoc: null,
                pageNum: 1,
                scale: 1.5, // Zoom por defecto para el S9
                cargando: false,
                
                // Modal Form
                modalOpen: false,
                form: { nombre: '', cantidad: 1, tipo: 'unidades' },

                async init() {
                    // Cargar lista al iniciar
                    try {
                        const res = await fetch(this.apiUrl);
                        this.listaCatalogos = await res.json();
                    } catch(e) { alert("Error conectando a Drive: " + e); }
                },

                async cargarCatalogoSeleccionado() {
                    if (!this.catalogoId) return;
                    this.cargando = true;
                    this.pdfDoc = null; // Limpiar anterior

                    try {
                        // 1. Pedir el archivo crudo al Script (puede tardar unos segundos)
                        const res = await fetch(`${this.apiUrl}?id=${this.catalogoId}`);
                        const respuesta = await res.json();
                        
                        if (respuesta.error) throw respuesta.error;

                        // 2. Decodificar Base64 a ArrayBuffer (Binario)
                        const binaryString = atob(respuesta.data);
                        const len = binaryString.length;
                        const bytes = new Uint8Array(len);
                        for (let i = 0; i < len; i++) {
                            bytes[i] = binaryString.charCodeAt(i);
                        }

                        // 3. Inicializar PDF.js
                        const loadingTask = pdfjsLib.getDocument(bytes);
                        this.pdfDoc = await loadingTask.promise;
                        this.renderPage(1);

                    } catch (e) {
                        alert("No se pudo cargar el cat√°logo. Puede ser muy pesado para el Script.");
                        console.error(e);
                    }
                    this.cargando = false;
                },

                async renderPage(num) {
                    this.pageNum = num;
                    const page = await this.pdfDoc.getPage(num);
                    
                    const canvas = document.getElementById('the-canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Ajustar viewport
                    const viewport = page.getViewport({ scale: this.scale });
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;

                    // Renderizar imagen
                    await page.render({ canvasContext: ctx, viewport: viewport }).promise;

                    // Renderizar TEXTO INVISIBLE (La Magia)
                    const textContent = await page.getTextContent();
                    const textLayer = document.getElementById('text-layer');
                    textLayer.style.height = viewport.height + 'px';
                    textLayer.style.width = viewport.width + 'px';
                    textLayer.innerHTML = ''; // Limpiar

                    pdfjsLib.renderTextLayer({
                        textContentSource: textContent,
                        container: textLayer,
                        viewport: viewport,
                        textDivs: []
                    });
                    
                    // A√±adir eventos a las palabras tras renderizar
                    setTimeout(() => {
                        const spans = textLayer.querySelectorAll('span');
                        spans.forEach(span => {
                            span.addEventListener('click', (e) => {
                                // "Limpiar" texto: quitar $ y n√∫meros raros
                                let txt = e.target.innerText;
                                if(txt.length < 3) return; // Ignorar ruido
                                
                                this.abrirForm(txt.replace(/[\$0-9,\.]{3,}/g, '').trim());
                            });
                        });
                    }, 200);
                },

                cambiarPag(dir) {
                    if(!this.pdfDoc) return;
                    const nueva = this.pageNum + dir;
                    if(nueva >= 1 && nueva <= this.pdfDoc.numPages) this.renderPage(nueva);
                },

                abrirForm(nombre) {
                    this.form.nombre = nombre;
                    this.form.cantidad = 1;
                    this.modalOpen = true;
                    if(navigator.vibrate) navigator.vibrate(30); // Tactil
                },

                guardar() {
                    this.items.unshift({ ...this.form });
                    localStorage.setItem('stock_drive', JSON.stringify(this.items));
                    this.modalOpen = false;
                    if(navigator.vibrate) navigator.vibrate([50, 30]); // Confirmaci√≥n
                    
                    // Mostrar notificaci√≥n flotante r√°pida (opcional)
                    const btn = document.querySelector('button[class*="bg-green"]');
                    btn.classList.add('animate-bounce');
                    setTimeout(() => btn.classList.remove('animate-bounce'), 1000);
                },

                verResumen() {
                    let txt = "*PEDIDO STOCK*\n\n";
                    this.items.forEach(i => txt += `${i.tipo == 'bulto'?'üß±':'üì¶'} ${i.cantidad} x ${i.nombre}\n`);
                    window.location.href = `https://wa.me/?text=${encodeURIComponent(txt)}`;
                }
            }
        }
    </script>
</body>
</html>
