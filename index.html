<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Catalog S9</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <script>
        // Configuraci贸n del Worker de PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <style>
        body { background-color: #121212; color: #e0e0e0; overflow: hidden; }
        
        /* Contenedor del PDF */
        #pdf-container {
            overflow: auto;
            position: relative;
            height: 100vh;
            background: #1a1a1a;
            touch-action: pan-x pan-y; /* Permite zoom y scroll nativo */
        }

        /* La magia: Capa de texto invisible pero cliqueable */
        .textLayer {
            position: absolute;
            left: 0; top: 0; right: 0; bottom: 0;
            overflow: hidden;
            opacity: 0.2; /* Truco: Ponlo en 0 para invisible, 0.2 para ver las zonas detectadas (debug) */
            line-height: 1.0;
            pointer-events: none; /* Dejar pasar toques al canvas si es necesario */
        }

        /* Cada palabra detectada se convierte en un bot贸n */
        .textLayer span {
            color: transparent;
            position: absolute;
            white-space: pre;
            cursor: pointer;
            transform-origin: 0% 0%;
            pointer-events: auto; /* Reactivar toques en el texto */
            border-radius: 2px;
        }

        /* Feedback visual al tocar un producto */
        .textLayer span:active {
            background-color: rgba(59, 130, 246, 0.5) !important; /* Azul */
        }
        
        /* Estilo S9 Dark Mode */
        .bottom-sheet {
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
    </style>
</head>

<body x-data="smartCatalog()" class="h-screen w-screen relative">

    <div class="absolute top-0 left-0 right-0 z-30 p-2 bg-gradient-to-b from-black/80 to-transparent pointer-events-none">
        <div class="pointer-events-auto flex justify-between items-center bg-gray-900/90 backdrop-blur rounded-full px-4 py-2 border border-gray-700 shadow-xl">
            <label class="flex items-center gap-2 text-sm font-bold text-blue-400 cursor-pointer">
                 Abrir PDF
                <input type="file" accept="application/pdf" class="hidden" @change="cargarPDF($event)">
            </label>
            
            <div class="text-xs text-gray-400 font-mono">
                P谩g: <span x-text="pageNum"></span>/<span x-text="totalParams"></span>
            </div>

            <button @click="verResumen()" class="bg-green-600 px-3 py-1 rounded-full text-xs font-bold text-white shadow-lg">
                 <span x-text="items.length"></span>
            </button>
        </div>
    </div>

    <div id="pdf-container" class="w-full h-full flex justify-center bg-black">
        <div id="page-wrapper" class="relative shadow-2xl">
            <canvas id="the-canvas" class="block"></canvas>
            <div id="text-layer" class="textLayer"></div>
        </div>
    </div>

    <div class="absolute bottom-20 right-4 z-20 flex flex-col gap-2 pointer-events-auto" x-show="pdfDoc">
        <button @click="prevPage" class="w-12 h-12 bg-gray-800/90 rounded-full flex items-center justify-center text-white border border-gray-600 shadow-lg active:scale-90">猬锔</button>
        <button @click="nextPage" class="w-12 h-12 bg-gray-800/90 rounded-full flex items-center justify-center text-white border border-gray-600 shadow-lg active:scale-90">猬锔</button>
    </div>

    <div class="fixed inset-x-0 bottom-0 z-50 transform transition-transform duration-300 bg-gray-900 border-t border-gray-700 rounded-t-3xl shadow-[0_-10px_50px_rgba(0,0,0,0.8)]"
         :class="modalAbierto ? 'translate-y-0' : 'translate-y-full'">
        
        <div class="p-5">
            <div class="w-12 h-1 bg-gray-600 rounded-full mx-auto mb-4"></div>

            <div class="space-y-4">
                <div>
                    <label class="text-xs text-gray-500 uppercase font-bold tracking-wider">Producto Detectado</label>
                    <input type="text" x-model="productoActual.nombre" class="w-full bg-transparent text-xl font-bold text-white border-b border-gray-600 focus:border-blue-500 outline-none py-1">
                </div>

                <div class="flex gap-2">
                    <button @click="productoActual.tipo = 'unidades'" 
                            :class="productoActual.tipo === 'unidades' ? 'bg-blue-600 text-white' : 'bg-gray-800 text-gray-400'"
                            class="flex-1 py-2 rounded-lg font-bold text-sm transition-colors border border-transparent focus:border-blue-400">
                         Unidad
                    </button>
                    <button @click="productoActual.tipo = 'bulto'" 
                            :class="productoActual.tipo === 'bulto' ? 'bg-purple-600 text-white' : 'bg-gray-800 text-gray-400'"
                            class="flex-1 py-2 rounded-lg font-bold text-sm transition-colors border border-transparent focus:border-purple-400">
                        П Bulto Cerrado
                    </button>
                </div>

                <div class="flex items-center gap-4">
                    <button @click="cambiarCant(-1)" class="w-12 h-12 rounded-full bg-gray-800 text-2xl font-bold text-red-400 active:bg-gray-700">-</button>
                    <input type="number" x-model="productoActual.cantidad" class="flex-1 text-center bg-gray-800 rounded-xl py-3 text-2xl font-bold text-white outline-none ring-2 ring-transparent focus:ring-blue-500">
                    <button @click="cambiarCant(1)" class="w-12 h-12 rounded-full bg-gray-800 text-2xl font-bold text-green-400 active:bg-gray-700">+</button>
                </div>

                <button @click="guardarItem()" class="w-full bg-gradient-to-r from-blue-600 to-blue-800 text-white font-bold py-3 rounded-xl shadow-lg active:scale-95 transform transition text-lg">
                    CONFIRMAR
                </button>
            </div>
        </div>
    </div>

    <script>
        function smartCatalog() {
            return {
                pdfDoc: null,
                pageNum: 1,
                totalParams: 0,
                scale: 1.5, // Zoom inicial para que se lea bien en el S9
                canvas: null,
                ctx: null,
                
                // Estado del App
                modalAbierto: false,
                items: [],
                productoActual: { nombre: '', cantidad: 1, tipo: 'unidades' },

                init() {
                    this.canvas = document.getElementById('the-canvas');
                    this.ctx = this.canvas.getContext('2d');
                    this.items = JSON.parse(localStorage.getItem('smart_stock')) || [];
                },

                async cargarPDF(e) {
                    const file = e.target.files[0];
                    if (!file) return;

                    const fileReader = new FileReader();
                    fileReader.onload = async function() {
                        const typedarray = new Uint8Array(this.result);
                        // Cargar documento PDF
                        const loadingTask = pdfjsLib.getDocument(typedarray);
                        window.app.pdfDoc = await loadingTask.promise;
                        window.app.totalParams = window.app.pdfDoc.numPages;
                        window.app.renderPage(1);
                    };
                    fileReader.readAsArrayBuffer(file);
                    
                    // Hack para acceder desde callbacks globales
                    window.app = this; 
                },

                async renderPage(num) {
                    this.pageNum = num;
                    const page = await this.pdfDoc.getPage(num);
                    
                    // Ajustar escala para m贸viles
                    const viewport = page.getViewport({ scale: this.scale });
                    this.canvas.height = viewport.height;
                    this.canvas.width = viewport.width;

                    // Renderizar imagen
                    const renderContext = {
                        canvasContext: this.ctx,
                        viewport: viewport
                    };
                    await page.render(renderContext).promise;

                    // --- LA MAGIA: PROCESAMIENTO DE TEXTO EN SEGUNDO PLANO ---
                    this.procesarCapaDeTexto(page, viewport);
                },

                async procesarCapaDeTexto(page, viewport) {
                    const textContent = await page.getTextContent();
                    const textLayerDiv = document.getElementById("text-layer");
                    
                    // Limpiar capa anterior
                    textLayerDiv.innerHTML = "";
                    textLayerDiv.style.height = viewport.height + 'px';
                    textLayerDiv.style.width = viewport.width + 'px';

                    // Crear overlay interactivo
                    // PDF.js nos da el texto y su posici贸n. Nosotros creamos "botones" sobre ellos.
                    pdfjsLib.renderTextLayer({
                        textContentSource: textContent,
                        container: textLayerDiv,
                        viewport: viewport,
                        textDivs: []
                    });
                    
                    // A帽adir listeners de clic a cada palabra/frase generada
                    // Esperamos un momento a que el DOM se genere
                    setTimeout(() => {
                        const spans = textLayerDiv.querySelectorAll('span');
                        spans.forEach(span => {
                            // Estilo para indicar interactividad (opcional, aqu铆 invisible)
                            span.onclick = (e) => {
                                // "Smart Parser": Limpiar el texto
                                let texto = e.target.innerText;
                                // Filtrar: Si es solo un precio o muy corto, ignorar o buscar contexto
                                if (texto.length < 3) return; 

                                this.abrirModal(texto);
                            }
                        });
                    }, 100);
                },

                abrirModal(nombreDetectado) {
                    // Limpieza simple de IA: Quitar precios si vienen pegados (ej: "Lavandina $500")
                    let nombreLimpio = nombreDetectado.replace(/[\$0-9]{3,}/g, '').trim();
                    
                    this.productoActual = {
                        nombre: nombreLimpio,
                        cantidad: 1,
                        tipo: 'unidades'
                    };
                    
                    if (navigator.vibrate) navigator.vibrate(30); // Feedback t谩ctil
                    this.modalAbierto = true;
                },

                guardarItem() {
                    const item = {
                        ...this.productoActual,
                        id: Date.now()
                    };
                    this.items.push(item);
                    localStorage.setItem('smart_stock', JSON.stringify(this.items));
                    
                    this.modalAbierto = false;
                    if (navigator.vibrate) navigator.vibrate([50, 50]); // Doble vibraci贸n confirmaci贸n
                    
                    // Reset
                    setTimeout(() => this.productoActual.cantidad = 1, 300);
                },

                cambiarCant(delta) {
                    let nueva = this.productoActual.cantidad + delta;
                    if (nueva < 1) nueva = 1;
                    this.productoActual.cantidad = nueva;
                },

                prevPage() {
                    if (this.pageNum <= 1) return;
                    this.renderPage(this.pageNum - 1);
                },
                nextPage() {
                    if (this.pageNum >= this.totalParams) return;
                    this.renderPage(this.pageNum + 1);
                },

                verResumen() {
                    let texto = " *PEDIDO GENERADO*\n\n";
                    this.items.forEach(i => {
                        let tipoIcon = i.tipo === 'bulto' ? 'П' : '';
                        texto += `${tipoIcon} ${i.cantidad} x ${i.nombre}\n`;
                    });
                    const url = `https://wa.me/?text=${encodeURIComponent(texto)}`;
                    window.location.href = url;
                }
            }
        }
    </script>
</body>
</html>
