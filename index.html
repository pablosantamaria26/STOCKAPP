<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stock R√°pido</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        /* Ajuste para que no se mueva el teclado al escribir */
        body { position: fixed; width: 100%; height: 100%; background: #000; overflow: hidden; }
        iframe { border: none; width: 100%; height: 100%; }
    </style>
</head>

<body x-data="stockApp()" x-init="init()" class="flex flex-col text-gray-100">

    <div class="flex-1 relative bg-gray-900 border-b-2 border-blue-600 transition-all duration-300" 
         :class="modoPantallaCompleta ? 'h-0 flex-none hidden' : 'h-[45%]'">
        
        <template x-if="catalogoUrl">
            <iframe :src="catalogoUrl" allow="autoplay"></iframe>
        </template>
        
        <div x-show="!catalogoUrl" class="absolute inset-0 flex items-center justify-center text-gray-500">
            <p>Selecciona un proveedor abajo üëá</p>
        </div>

        <button @click="modoPantallaCompleta = !modoPantallaCompleta" 
                class="absolute bottom-2 right-2 bg-black/70 p-2 rounded-full text-white text-xs z-10 border border-gray-600">
            ‚ÜïÔ∏è Ampliar Lista
        </button>
    </div>

    <div class="flex flex-col bg-black transition-all duration-300"
         :class="modoPantallaCompleta ? 'h-full' : 'h-[55%]'">
        
        <div class="p-2 bg-gray-900 flex gap-2 items-center shadow-lg z-20">
            <select x-model="catalogoUrl" class="bg-gray-800 text-white text-sm rounded px-2 py-2 flex-1 border border-gray-700 outline-none">
                <option value="">üìÇ Ver Cat√°logo...</option>
                <template x-for="c in catalogos" :key="c.url">
                    <option :value="c.url" x-text="c.nombre"></option>
                </template>
            </select>
            
            <button @click="verResumen()" class="bg-green-600 px-3 py-2 rounded font-bold text-sm whitespace-nowrap">
                Env√≠ar (<span x-text="items.length"></span>)
            </button>
        </div>

        <div class="px-2 pt-2 pb-1 bg-black">
            <div class="relative">
                <input type="text" x-model="busqueda" x-ref="inputBusqueda"
                       placeholder="üîç Escribe producto (ej: lavandina)..." 
                       class="w-full bg-gray-800 text-white rounded-lg pl-3 pr-10 py-3 text-lg font-medium outline-none border border-gray-700 focus:border-blue-500">
                
                <button x-show="busqueda" @click="busqueda=''; $refs.inputBusqueda.focus()" class="absolute right-2 top-2 text-gray-400 p-1 text-xl">‚úï</button>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-2 space-y-2 pb-20">
            
            <div x-show="busqueda.length > 0" class="bg-blue-900/30 border border-blue-500/50 p-3 rounded-xl flex justify-between items-center animate-pulse">
                <div>
                    <span class="text-gray-400 text-xs uppercase">Agregar Nuevo:</span>
                    <div class="font-bold text-xl text-white" x-text="busqueda"></div>
                </div>
                <button @click="agregar(busqueda)" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-6 rounded-lg shadow-lg active:scale-95">
                    + CARGAR
                </button>
            </div>

            <template x-for="(item, index) in items" :key="index">
                <div class="bg-gray-800 p-3 rounded-xl flex justify-between items-center border border-gray-700 shadow-sm">
                    <div class="flex flex-col flex-1">
                        <span class="font-medium text-lg text-gray-200" x-text="item.nombre"></span>
                        <div class="flex gap-2 mt-1">
                            <span class="text-xs px-2 py-0.5 rounded bg-gray-700 text-gray-300" x-text="item.tipo"></span>
                        </div>
                    </div>

                    <div class="flex items-center gap-3 bg-black/50 rounded-lg p-1 ml-2">
                        <button @click="cambiarCant(index, -1)" class="w-8 h-8 rounded bg-gray-700 text-red-400 font-bold text-xl flex items-center justify-center active:bg-gray-600">-</button>
                        <span class="w-8 text-center font-bold text-xl text-white" x-text="item.cantidad"></span>
                        <button @click="cambiarCant(index, 1)" class="w-8 h-8 rounded bg-gray-700 text-green-400 font-bold text-xl flex items-center justify-center active:bg-gray-600">+</button>
                    </div>
                </div>
            </template>

            <div x-show="items.length === 0 && !busqueda" class="text-center text-gray-600 mt-8">
                <p class="text-4xl mb-2">üì¶</p>
                <p>Lista vac√≠a.</p>
                <p class="text-sm">Mira el cat√°logo arriba y escribe abajo.</p>
            </div>
        </div>
    </div>

    <div x-show="modalOpen" class="fixed inset-0 z-50 bg-black/80 flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-gray-900 w-full max-w-sm rounded-2xl border border-gray-700 p-5 shadow-2xl">
            <h3 class="text-xl font-bold text-center mb-4 text-white">¬øC√≥mo lo vendes?</h3>
            <div class="bg-gray-800 p-3 rounded mb-4 text-center text-blue-300 font-medium" x-text="tempNombre"></div>
            
            <div class="grid grid-cols-2 gap-4 mb-4">
                <button @click="confirmarAgregar('UNIDAD')" class="bg-blue-600 py-4 rounded-xl font-bold text-white shadow-lg active:scale-95">
                    üì¶ UNIDAD
                </button>
                <button @click="confirmarAgregar('BULTO')" class="bg-purple-600 py-4 rounded-xl font-bold text-white shadow-lg active:scale-95">
                    üß± BULTO
                </button>
            </div>
            <button @click="modalOpen = false" class="w-full py-3 text-gray-400 font-medium">Cancelar</button>
        </div>
    </div>

    <script>
        function stockApp() {
            return {
                // PEGA TU URL DEL SCRIPT AQUI (La versi√≥n simple del Paso 1)
                apiUrl: 'https://script.google.com/macros/s/AKfycbySwsXfzeNUHi3VWqGWcJtMmpzLjkSRlBEs7a8_FoaGKqgifoBJRFqAhIV_oTTHAJf40A/exec',
                
                catalogos: [],
                catalogoUrl: '',
                items: JSON.parse(localStorage.getItem('stock_simple')) || [],
                busqueda: '',
                modoPantallaCompleta: false,
                
                // Variables del Modal
                modalOpen: false,
                tempNombre: '',

                async init() {
                    try {
                        const res = await fetch(this.apiUrl);
                        this.catalogos = await res.json();
                    } catch(e) { console.error(e); }
                },

                agregar(nombre) {
                    this.tempNombre = nombre;
                    this.modalOpen = true; // Preguntar si es bulto o unidad
                },

                confirmarAgregar(tipo) {
                    // Buscar si ya existe para sumar
                    let existe = this.items.find(i => i.nombre === this.tempNombre && i.tipo === tipo);
                    
                    if (existe) {
                        existe.cantidad++;
                    } else {
                        this.items.unshift({
                            nombre: this.tempNombre,
                            cantidad: 1,
                            tipo: tipo
                        });
                    }
                    
                    this.guardar();
                    this.modalOpen = false;
                    this.busqueda = ''; // Limpiar buscador
                    
                    // Vibraci√≥n de √©xito
                    if(navigator.vibrate) navigator.vibrate(50);
                },

                cambiarCant(index, delta) {
                    this.items[index].cantidad += delta;
                    if (this.items[index].cantidad <= 0) {
                        if(confirm('¬øBorrar este art√≠culo?')) {
                            this.items.splice(index, 1);
                        } else {
                            this.items[index].cantidad = 1;
                        }
                    }
                    this.guardar();
                },

                guardar() {
                    localStorage.setItem('stock_simple', JSON.stringify(this.items));
                },

                verResumen() {
                    let texto = "*PEDIDO STOCK*\n\n";
                    this.items.forEach(i => {
                        let icono = i.tipo === 'BULTO' ? 'üß±' : 'üì¶';
                        texto += `${icono} ${i.cantidad} x ${i.nombre}\n`;
                    });
                    window.location.href = `https://wa.me/?text=${encodeURIComponent(texto)}`;
                }
            }
        }
    </script>
</body>
</html>
