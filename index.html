<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#000000">
    <title>Stock Tactical S9</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <style>
        /* OptimizaciÃ³n S9: Scroll suave y negros puros para pantalla AMOLED */
        body { background-color: #000000; color: #e5e5e5; overscroll-behavior: none; }
        
        /* Ocultar scrollbar pero permitir scroll */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* AnimaciÃ³n del panel de lista (Bottom Sheet) */
        .sheet-transition { transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
        .sheet-open { transform: translateY(0); }
        .sheet-closed { transform: translateY(100%); }

        /* Efecto de onda al hablar */
        .voice-active { box-shadow: 0 0 15px #ef4444; animation: pulse-red 1.5s infinite; }
        @keyframes pulse-red { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
    </style>
</head>

<body x-data="tacticalApp()" x-init="init()" class="h-[100dvh] flex flex-col relative overflow-hidden">

    <div class="flex-1 relative z-0 bg-black">
        <template x-if="catalogoUrl">
            <iframe :src="`https://docs.google.com/gview?embedded=true&url=${encodeURIComponent(catalogoUrl)}`" 
                    class="w-full h-full border-none" 
                    style="background-color: #1a1a1a;">
            </iframe>
        </template>
        
        <div x-show="!catalogoUrl" class="absolute inset-0 flex flex-col items-center justify-center p-6 text-center opacity-60">
            <div class="mb-4 text-6xl animate-pulse">ðŸ“¡</div>
            <h2 class="text-xl font-bold uppercase tracking-widest text-blue-500">Sistema Listo</h2>
            <p class="text-sm mt-2 text-gray-400">Selecciona proveedor en el menÃº superior</p>
        </div>
    </div>

    <div class="absolute top-0 left-0 right-0 z-20 bg-gradient-to-b from-black/90 to-transparent p-3 backdrop-blur-[2px]">
        <select x-model="catalogoUrl" class="w-full bg-gray-900/80 text-white border border-gray-700 rounded-full px-4 py-2 text-sm font-medium shadow-lg focus:ring-2 focus:ring-blue-500 outline-none appearance-none">
            <option value="">ðŸ“‚ SELECCIONAR PROVEEDOR</option>
            <template x-for="cat in catalogos" :key="cat.id">
                <option :value="cat.url" x-text="cat.nombre"></option>
            </template>
        </select>
    </div>

    <div class="absolute bottom-0 left-0 right-0 z-40 p-3 pb-4 bg-gray-900 border-t border-gray-800 shadow-2xl flex gap-2 items-center">
        
        <button @click="toggleLista()" class="p-3 rounded-full bg-gray-800 text-white relative active:scale-95 transition">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
            <span x-show="items.length > 0" x-text="items.length" class="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] font-bold w-5 h-5 flex items-center justify-center rounded-full shadow-sm"></span>
        </button>

        <form @submit.prevent="agregarManual" class="flex-1 flex gap-2">
            <input x-model="inputRaw" x-ref="mainInput" type="text" placeholder="Ej: Lavandina 10" 
                   class="w-full bg-gray-800 text-white rounded-xl px-4 py-3 text-sm focus:bg-gray-700 outline-none border border-gray-700 focus:border-blue-500 transition-colors placeholder-gray-500"
                   inputmode="text" autocomplete="off">
        </form>

        <button @click="toggleVoz()" 
                :class="escuchando ? 'bg-red-600 text-white voice-active' : 'bg-blue-600 text-white'"
                class="p-3 rounded-full shadow-lg active:scale-90 transition-all duration-200">
            <svg x-show="!escuchando" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>
            <svg x-show="escuchando" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"></path></svg>
        </button>
    </div>

    <div class="absolute inset-0 z-30 bg-black/80 backdrop-blur-sm transition-opacity" 
         x-show="listaAbierta" @click="toggleLista()" x-transition.opacity></div>

    <div :class="listaAbierta ? 'sheet-open' : 'sheet-closed'" 
         class="absolute bottom-0 left-0 right-0 z-50 bg-gray-900 rounded-t-3xl shadow-[0_-10px_40px_rgba(0,0,0,0.5)] h-[80dvh] flex flex-col sheet-transition border-t border-gray-700">
        
        <div class="w-full flex justify-center p-3" @click="toggleLista()">
            <div class="w-12 h-1.5 bg-gray-600 rounded-full"></div>
        </div>

        <div class="px-5 pb-3 flex justify-between items-center border-b border-gray-800">
            <h3 class="text-white font-bold text-lg">Resumen de Pedido</h3>
            <button @click="enviarWhatsApp" class="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2">
                <span>ðŸš€</span> Enviar WhatsApp
            </button>
        </div>

        <div class="flex-1 overflow-y-auto p-4 space-y-3 no-scrollbar">
            <template x-for="(item, index) in items" :key="index">
                <div class="bg-gray-800 p-3 rounded-xl flex justify-between items-center border border-gray-700">
                    <span class="text-gray-200 font-medium" x-text="item.nombre"></span>
                    <div class="flex items-center gap-4">
                        <span class="text-blue-400 font-bold text-lg" x-text="item.cantidad"></span>
                        <button @click="eliminar(index)" class="text-gray-500 hover:text-red-400 p-2">âœ•</button>
                    </div>
                </div>
            </template>
            <div x-show="items.length === 0" class="text-center text-gray-500 mt-10">
                Lista vacÃ­a.<br>Usa el micrÃ³fono o escribe abajo.
            </div>
        </div>
    </div>

    <div x-show="notificacion" x-transition.duration.300ms class="absolute top-20 left-1/2 transform -translate-x-1/2 z-50 bg-blue-600 text-white px-6 py-2 rounded-full shadow-xl font-bold text-sm flex items-center gap-2">
        <span>âœ…</span> <span x-text="notificacion"></span>
    </div>

    <script>
        function tacticalApp() {
            return {
                // CONFIGURACIÃ“N (Pega tu URL del script aquÃ­)
                apiUrl: 'https://script.google.com/macros/s/AKfycbySwsXfzeNUHi3VWqGWcJtMmpzLjkSRlBEs7a8_FoaGKqgifoBJRFqAhIV_oTTHAJf40A/exec',
                
                // ESTADO
                catalogos: [],
                catalogoUrl: '',
                items: JSON.parse(localStorage.getItem('stock_s9')) || [],
                inputRaw: '',
                listaAbierta: false,
                notificacion: '',
                escuchando: false,
                recognition: null,

                async init() {
                    // Cargar catÃ¡logos
                    try {
                        const res = await fetch(this.apiUrl);
                        this.catalogos = await res.json();
                    } catch(e) { console.error(e); }

                    // Configurar Voz (Web Speech API)
                    if ('webkitSpeechRecognition' in window) {
                        this.recognition = new webkitSpeechRecognition();
                        this.recognition.continuous = false;
                        this.recognition.lang = 'es-AR'; // Acento Argentino
                        
                        this.recognition.onresult = (event) => {
                            const transcript = event.results[0][0].transcript;
                            this.inputRaw = transcript;
                            this.procesarTexto(transcript);
                            this.escuchando = false;
                        };
                        
                        this.recognition.onerror = () => { this.escuchando = false; };
                        this.recognition.onend = () => { this.escuchando = false; };
                    }
                },

                // --- LÃ³gica "Ingeniosa" de Procesamiento de Texto ---
                // Convierte "Lavandina 5" o "5 trapos de piso" en datos estructurados
                procesarTexto(texto) {
                    // Regex para encontrar nÃºmeros
                    const matchNumero = texto.match(/(\d+)/);
                    let cantidad = 1;
                    let nombre = texto;

                    if (matchNumero) {
                        cantidad = parseInt(matchNumero[0]);
                        // Quitamos el nÃºmero del nombre para limpiarlo
                        nombre = texto.replace(matchNumero[0], '').replace('unidades', '').trim();
                    }

                    this.agregarItem(nombre, cantidad);
                },

                agregarManual() {
                    if(!this.inputRaw) return;
                    this.procesarTexto(this.inputRaw);
                },

                agregarItem(nombre, cantidad) {
                    if (!nombre) return;
                    
                    // Capitalizar primera letra
                    nombre = nombre.charAt(0).toUpperCase() + nombre.slice(1);

                    this.items.unshift({ nombre, cantidad });
                    this.guardar();
                    this.inputRaw = '';
                    
                    // FEEDBACK SENSORIAL (S9)
                    // 1. VibraciÃ³n corta (Haptic)
                    if (navigator.vibrate) navigator.vibrate(50);
                    // 2. NotificaciÃ³n Visual
                    this.mostrarToast(`Agregado: ${cantidad}x ${nombre}`);
                },

                eliminar(index) {
                    this.items.splice(index, 1);
                    this.guardar();
                    if (navigator.vibrate) navigator.vibrate([30, 50, 30]); // Doble vibraciÃ³n al borrar
                },

                guardar() {
                    localStorage.setItem('stock_s9', JSON.stringify(this.items));
                },

                toggleLista() {
                    this.listaAbierta = !this.listaAbierta;
                    if (navigator.vibrate) navigator.vibrate(20);
                },

                toggleVoz() {
                    if (!this.recognition) return alert("Tu navegador no soporta voz. Usa Chrome.");
                    
                    if (this.escuchando) {
                        this.recognition.stop();
                    } else {
                        this.escuchando = true;
                        this.recognition.start();
                        if (navigator.vibrate) navigator.vibrate(100); // VibraciÃ³n larga al iniciar escucha
                    }
                },

                mostrarToast(msj) {
                    this.notificacion = msj;
                    setTimeout(() => this.notificacion = '', 2000);
                },

                enviarWhatsApp() {
                    let texto = "ðŸ“¦ *PEDIDO STOCK*\n\n";
                    this.items.forEach(i => texto += `â–ª ${i.cantidad} x ${i.nombre}\n`);
                    window.location.href = `https://wa.me/?text=${encodeURIComponent(texto)}`;
                }
            }
        }
    </script>
</body>
</html>
